{% extends "admin/admin_base.html" %}
{% block title %}Newsletter History{% endblock %}

{% block content %}
<div class="container-fluid my-4">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-envelope-open-text"></i> Newsletter History</h2>
    <div>
      <a href="{{ url_for('admin.create_newsletter') }}" class="btn btn-success">
        <i class="fas fa-plus"></i> Create New Newsletter
      </a>
      <a href="{{ url_for('admin.view_subscribers') }}" class="btn btn-info">
        <i class="fas fa-users"></i> View Subscribers
      </a>
    </div>
  </div>

  {% if newsletters %}
  <div class="card shadow">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th style="width: 80px;">Image</th>
              <th>Title</th>
              <th style="width: 300px;">Preview</th>
              <th style="width: 180px;">Date Created</th>
              <th style="width: 220px;" class="text-center">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for newsletter in newsletters %}
            <tr>
              <!-- Image Thumbnail -->
              <td>
                {% if newsletter.image_filename %}
                <img src="{{ url_for('static', filename='uploads/newsletters/' ~ newsletter.image_filename) }}" 
                     alt="{{ newsletter.title }}"
                     class="img-thumbnail"
                     style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                <div class="bg-secondary text-white d-flex align-items-center justify-content-center" 
                     style="width: 60px; height: 60px; border-radius: 4px;">
                  <i class="fas fa-image"></i>
                </div>
                {% endif %}
              </td>

              <!-- Title -->
              <td>
                <strong>{{ newsletter.title }}</strong>
              </td>

              <!-- Content Preview -->
              <td>
                <small class="text-muted">
                  {{ newsletter.content|striptags|truncate(100) }}
                </small>
              </td>

              <!-- Date -->
              <td>
                <small>
                  <i class="fas fa-calendar text-muted"></i>
                  {{ newsletter.created_at.strftime('%d %b %Y') if newsletter.created_at else 'â€”' }}<br>
                  <span class="text-muted">{{ newsletter.created_at.strftime('%I:%M %p') if newsletter.created_at else '' }}</span>
                </small>
              </td>

              <!-- Actions -->
              <td class="text-center">
                <div class="btn-group" role="group">
                  <a href="{{ url_for('admin.view_newsletter', newsletter_id=newsletter.id) }}" 
                     class="btn btn-sm btn-primary" 
                     title="View">
                    <i class="fas fa-eye"></i> View
                  </a>
                  <a href="{{ url_for('admin.edit_newsletter', newsletter_id=newsletter.id) }}" 
                     class="btn btn-sm btn-warning" 
                     title="Edit">
                    <i class="fas fa-edit"></i> Edit
                  </a>
                  <button type="button" 
                          class="btn btn-sm btn-danger" 
                          data-bs-toggle="modal" 
                          data-bs-target="#deleteModal{{ newsletter.id }}"
                          title="Delete">
                    <i class="fas fa-trash"></i> Delete
                  </button>
                </div>
              </td>
            </tr>

            <!-- Delete Confirmation Modal (Small) -->
            <div class="modal fade" id="deleteModal{{ newsletter.id }}" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                  <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">
                      <i class="fas fa-exclamation-triangle"></i> Confirm Delete
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                  </div>
                  <div class="modal-body">
                    <p>Are you sure you want to delete this newsletter?</p>
                    <p class="fw-bold text-danger">{{ newsletter.title }}</p>
                    <p class="text-muted small mb-0">This action cannot be undone.</p>
                  </div>
                  <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form method="POST" action="{{ url_for('admin.delete_newsletter', newsletter_id=newsletter.id) }}" class="d-inline">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                      <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash"></i> Delete
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Summary Stats -->
  <div class="mt-3">
    <p class="text-muted">
      <i class="fas fa-info-circle"></i> Total Newsletters: <strong>{{ newsletters|length }}</strong>
    </p>
  </div>

  {% else %}
  <!-- Empty State -->
  <div class="text-center py-5">
    <i class="fas fa-inbox fa-5x text-muted mb-3"></i>
    <h4 class="text-muted">No Newsletters Yet</h4>
    <p class="text-muted">You haven't created any newsletters yet.</p>
    <a href="{{ url_for('admin.create_newsletter') }}" class="btn btn-success btn-lg">
      <i class="fas fa-plus"></i> Create Your First Newsletter
    </a>
  </div>
  {% endif %}
</div>

<style>
.table tbody tr {
  transition: background-color 0.2s;
}

.table tbody tr:hover {
  background-color: #f8f9fa;
}

.btn-group .btn {
  border-radius: 0;
}

.btn-group .btn:first-child {
  border-radius: 4px 0 0 4px;
}

.btn-group .btn:last-child {
  border-radius: 0 4px 4px 0;
}
</style>
{% endblock %}