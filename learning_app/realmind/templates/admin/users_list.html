{% extends "admin/admin_base.html" %}
{% block content %}

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<div class="container-fluid py-4">

  <div class="card shadow-sm">
    <div class="card-header text-white d-flex justify-content-between align-items-center"
         style="background-color:#143670;">
      <h3 class="mb-0 text-center">Registered Users</h3>
    </div>

    <div class="card-body">

      <!-- USERS TABLE (NO WRAPPING FORM) -->
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-dark">
            <tr>
              <th><input type="checkbox" id="selectAll"></th>
              <th>Name</th>
              <th>Email</th>
              <th>Status</th>
              <th style="width:260px;">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for user in users %}
            <tr {% if not user.is_active %}class="table-secondary"{% endif %}>
              <td>
                <input type="checkbox"
                       class="user-checkbox"
                       value="{{ user.id }}"
                       {% if not user.is_active %}disabled{% endif %}>
              </td>

              <td>{{ user.fullname }}</td>
              <td>{{ user.email }}</td>

              <td>
                {% if user.is_active %}
                  <span class="badge bg-success">Active</span>
                {% else %}
                  <span class="badge bg-secondary">Inactive</span>
                {% endif %}
              </td>

              <td>
                <div class="d-flex gap-2">

                  <a href="{{ url_for('admin.send_message_single', user_id=user.id) }}"
                     class="btn btn-primary btn-sm"
                     {% if not user.is_active %}disabled{% endif %}>
                    Message
                  </a>

                  <a href="{{ url_for('admin.view_user', user_id=user.id) }}"
                     class="btn btn-info btn-sm">
                    View
                  </a>

                  {% if user.is_active %}
                  <button class="btn btn-warning btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#deactivateModal{{ user.id }}">
                    Deactivate
                  </button>
                  {% else %}
                  <button class="btn btn-success btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#activateModal{{ user.id }}">
                    Activate
                  </button>
                  {% endif %}

                </div>
              </td>
            </tr>

            <!-- DEACTIVATE MODAL -->
            <div class="modal fade" id="deactivateModal{{ user.id }}" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">

                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Deactivation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    <p class="fw-bold text-warning">
                      Deactivate <strong>{{ user.fullname }}</strong>?
                    </p>
                  </div>

                  <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                    <form method="POST"
                          action="{{ url_for('admin.deactivate_user', user_id=user.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-warning">Deactivate</button>
                    </form>
                  </div>

                </div>
              </div>
            </div>

            <!-- ðŸŸ¢ ACTIVATE MODAL -->
            <div class="modal fade" id="activateModal{{ user.id }}" tabindex="-1">
              <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">

                  <div class="modal-header">
                    <h5 class="modal-title">Confirm Activation</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                  </div>

                  <div class="modal-body">
                    <p class="fw-bold text-success">
                      Activate <strong>{{ user.fullname }}</strong>?
                    </p>
                  </div>

                  <div class="modal-footer">
                    <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>

                    <form method="POST"
                          action="{{ url_for('admin.activate_user', user_id=user.id) }}">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <button type="submit" class="btn btn-success">Activate</button>
                    </form>
                  </div>

                </div>
              </div>
            </div>

            {% endfor %}
          </tbody>
        </table>
      </div>

      <!-- âœ… BULK MESSAGE FORM (SEPARATE & SAFE) -->
      <form id="bulkMessageForm"
            action="{{ url_for('admin.bulk_message') }}"
            method="POST"
            class="text-center mt-3">

        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
        <input type="hidden" name="selected_ids" id="selected_ids">

        <button type="submit" class="btn btn-warning">
          Send Bulk Message
        </button>
      </form>

    </div>
  </div>
</div>

<!-- âœ… JS -->
<script>
  const selectAll = document.getElementById("selectAll");
  const checkboxes = document.querySelectorAll(".user-checkbox");
  const selectedIds = document.getElementById("selected_ids");

  selectAll.addEventListener("change", () => {
    checkboxes.forEach(cb => {
      if (!cb.disabled) cb.checked = selectAll.checked;
    });
  });

  document.getElementById("bulkMessageForm").addEventListener("submit", () => {
    const ids = Array.from(checkboxes)
      .filter(cb => cb.checked)
      .map(cb => cb.value);

    selectedIds.value = ids.join(",");
  });
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

{% endblock %}
