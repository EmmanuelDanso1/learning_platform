{% extends "index.html" %}
{% block title %}Edit Profile{% endblock %}

{% block content %}

<style>
    .profile-img-wrapper {
        width: 250px;
        height: 250px;
        border-radius: 50%;
        overflow: hidden;
        border: 5px solid #000;
        margin: 0 auto;
    }

    .profile-img-wrapper img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .upload-btn {
        display: inline-block;
        background: #f0f0f0;
        padding: 10px 25px;
        border-radius: 12px;
        border: 2px solid #000;
        cursor: pointer;
        font-weight: bold;
    }

    .form-label {
        font-weight: 700;
        color: #00194F;
    }

    .required-asterisk {
        color: red;
        font-weight: bold;
        margin-left: 3px;
    }

    .custom-input, .custom-select {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 2px solid #000;
        font-size: 16px;
    }

    .upload-box {
        border: 2px solid #000;
        border-radius: 12px;
        padding: 10px;
    }
</style>


<div class="container py-5">
    <form action="{{ url_for('user.edit_profile') }}" method="POST" enctype="multipart/form-data">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

        <h2 class="text-center mb-4 fw-bold">Edit Profile</h2>

        <!-- PROFILE IMAGE -->
        <div class="text-center mb-4">
            <div class="profile-img-wrapper mb-3">
                {% if current_user.profile_pic %}
                <img id="previewImg" 
                     src="{{ url_for('static', filename='uploads/users/user_' ~ current_user.id ~ '/profile/' ~ current_user.profile_pic) }}?v={{ current_user.profile_pic }}">
                {% else %}
                <img id="previewImg" src="{{ url_for('static', filename='images/default-profile.webp') }}">
                {% endif %}
            </div>

            <label class="upload-btn">
                Upload Profile Picture (Optional)
                <input type="file" id="profileInput" name="profile_pic" accept="image/*" hidden>
            </label>
        </div>


        <!-- MAIN FORM -->
        <div class="row gy-4">

            <div class="col-md-4">
                <label class="form-label">First Name<span class="required-asterisk">*</span></label>
                <input type="text" name="firstname" value="{{ current_user.firstname or ''}}" class="custom-input" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Surname<span class="required-asterisk">*</span></label>
                <input type="text" name="surname" value="{{ current_user.surname  or '' }}" class="custom-input" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Other Names</label>
                <input type="text" name="other_names" value="{{ current_user.other_names  or '' }}" class="custom-input">
            </div>

            <div class="col-md-6">
                <label class="form-label">E-mail Address<span class="required-asterisk">*</span></label>
                <input type="email" name="email" value="{{ current_user.email  or ''}}" class="custom-input" required>
            </div>

            <div class="col-md-6">
                <label class="form-label">Phone Number<span class="required-asterisk">*</span></label>
                <input type="text" name="phone" value="{{ current_user.phone  or ''}}" class="custom-input" required>
            </div>


            <!-- ========================= -->
            <!-- GHANA CARD / CV / CERTIFICATE (INLINE) -->
            <!-- ========================= -->
            <div class="col-md-4">
                <label class="form-label">Ghana Card Number<span class="required-asterisk">*</span></label>
                <input type="text" name="ghana_card_number" value="{{ current_user.ghana_card_number  or ''}}" placeholder="GHA-000000000-0" class="custom-input" required>
            </div>

            <div class="col-md-4">
                <label class="form-label">Upload CV<span class="required-asterisk">*</span></label>
                <div class="upload-box">
                    <input type="file" name="cv" accept=".pdf,.doc,.docx" class="form-control" {% if not current_user.cv %}required{% endif %}>
                </div>

                {% if current_user.cv %}
                    <small class="text-success">Current CV:
                        <a href="{{ url_for('static', filename='uploads/users/user_' ~ current_user.id ~ '/documents/' ~ current_user.cv) }}" target="_blank">View / Download</a>
                    </small>
                {% endif %}
            </div>

            <div class="col-md-4">
                <label class="form-label">Upload Certificate<span class="required-asterisk">*</span></label>
                <div class="upload-box">
                    <input type="file" name="certificate" accept=".pdf,.jpg,.jpeg,.png" class="form-control" {% if not current_user.certificate %}required{% endif %}>
                </div>

                {% if current_user.certificate %}
                    <small class="text-success">Current Certificate:
                        <a href="{{ url_for('static', filename='uploads/users/user_' ~ current_user.id ~ '/documents/' ~ current_user.certificate) }}" target="_blank">View / Download</a>
                    </small>
                {% endif %}
            </div>




            <!-- ========================= -->
            <!-- PREFERRED SUBJECT & LEVEL -->
            <!-- ========================= -->
            <div class="col-md-6">
                <label class="form-label">Preferred Subject<span class="required-asterisk">*</span></label>

                <div class="custom-select-container" style="border:1px solid #ced4da; padding:10px; border-radius:5px; max-height:200px; overflow-y:auto;">
                    {% set selected_subjects = (current_user.preferred_subject or '').split(',') %}

                    {% for subject in subjects %}
                    <div class="d-flex align-items-center mb-1">
                        <input type="checkbox" 
                            name="preferred_subject" 
                            value="{{ subject }}"
                            style="margin-right:8px;"
                            class="subject-checkbox"
                            {% if subject in selected_subjects %}checked{% endif %}>
                        <span>{{ subject }}</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Hidden input to enforce at least one checkbox selection -->
                <input type="hidden" id="subjectRequired" name="subject_validation" required>

                <!-- Other Input -->
                {% set other_subject = '' %}
                {% for s in selected_subjects %}
                    {% if s not in subjects %}
                        {% set other_subject = s %}
                    {% endif %}
                {% endfor %}

                <input type="text" name="preferred_subject_other"
                    id="subjectOtherInput"
                    class="custom-input mt-2"
                    placeholder="Enter other subject"
                    value="{{ other_subject }}"
                    {% if other_subject %}style="display:block;"{% else %}style="display:none;"{% endif %}>
            </div>

            <div class="col-md-6">
                <label class="form-label">Preferred Level<span class="required-asterisk">*</span></label>

                <div class="custom-select-container" style="border:1px solid #ced4da; padding:10px; border-radius:5px; max-height:250px; overflow-y:auto;">
                    
                    {% set saved_levels = (current_user.preferred_level or "").split(",") %}

                    {% set level_options = [
                        "Pre-School",
                        "Lower Primary",
                        "Upper Primary",
                        "Junior High",
                        "Lower Secondary",
                        "Senior High",
                        "Upper Secondary",
                        "O-Level",
                        "A-Level"
                    ] %}

                    {% for level in level_options %}
                    <div class="d-flex align-items-center mb-1">
                        <input type="checkbox"
                            name="preferred_level"
                            value="{{ level }}"
                            style="margin-right:8px;"
                            class="level-checkbox"
                            {% if level in saved_levels %}checked{% endif %}>
                        <span>{{ level }}</span>
                    </div>
                    {% endfor %}
                </div>

                <!-- Hidden input to enforce at least one checkbox selection -->
                <input type="hidden" id="levelRequired" name="level_validation" required>
            </div>

        </div>


        <div class="text-center mt-5">
            <button type="submit" class="btn btn-warning px-5 py-2 fw-bold">Save Changes</button>
        </div>
        
    </form>
</div>

<script>
// Show live preview for profile image
document.getElementById("profileInput").addEventListener("change", function(e) {
    const file = e.target.files[0];
    if (file) {
        document.getElementById("previewImg").src = URL.createObjectURL(file);
    }
});

// Show/hide Other subject input when "Other" checkbox is checked
const subjectCheckboxes = document.querySelectorAll("input[name='preferred_subject']");
const otherInput = document.getElementById("subjectOtherInput");

function toggleOtherInput() {
    const otherChecked = Array.from(subjectCheckboxes).some(cb => cb.value === "Other" && cb.checked);
    if (otherChecked) {
        otherInput.style.display = "block";
    } else {
        otherInput.style.display = "none";
        otherInput.value = "";
    }
}

// Attach event listener to all checkboxes
subjectCheckboxes.forEach(cb => cb.addEventListener("change", toggleOtherInput));

// Run on page load
window.addEventListener("DOMContentLoaded", toggleOtherInput);

// Validate at least one subject is selected
const subjectValidation = document.getElementById('subjectRequired');
const levelValidation = document.getElementById('levelRequired');

function validateSubjects() {
    const anySubjectChecked = Array.from(subjectCheckboxes).some(cb => cb.checked);
    if (anySubjectChecked) {
        subjectValidation.setCustomValidity('');
    } else {
        subjectValidation.setCustomValidity('Please select at least one subject');
    }
}

function validateLevels() {
    const levelCheckboxes = document.querySelectorAll("input[name='preferred_level']");
    const anyLevelChecked = Array.from(levelCheckboxes).some(cb => cb.checked);
    if (anyLevelChecked) {
        levelValidation.setCustomValidity('');
    } else {
        levelValidation.setCustomValidity('Please select at least one level');
    }
}

// Validate on checkbox change
subjectCheckboxes.forEach(cb => {
    cb.addEventListener('change', validateSubjects);
});

document.querySelectorAll("input[name='preferred_level']").forEach(cb => {
    cb.addEventListener('change', validateLevels);
});

// Initial validation on page load
window.addEventListener('DOMContentLoaded', function() {
    validateSubjects();
    validateLevels();
});

// Validate before form submission
document.querySelector('form').addEventListener('submit', function(e) {
    validateSubjects();
    validateLevels();
    
    const anySubjectChecked = Array.from(subjectCheckboxes).some(cb => cb.checked);
    const levelCheckboxes = document.querySelectorAll("input[name='preferred_level']");
    const anyLevelChecked = Array.from(levelCheckboxes).some(cb => cb.checked);
    
    if (!anySubjectChecked) {
        e.preventDefault();
        alert('Please select at least one preferred subject');
        return false;
    }
    
    if (!anyLevelChecked) {
        e.preventDefault();
        alert('Please select at least one preferred level');
        return false;
    }
});
</script>

{% endblock %}